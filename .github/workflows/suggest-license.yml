name: Auto-Fix Missing License

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Target Repository (e.g. facebook/react)"
        required: true
        type: string
  issues:
    types: [labeled, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  fix-license:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' || 
      (contains(github.event.issue.labels.*.name, 'missing-license') && github.actor == github.repository_owner)

    steps:
      - name: Validate Inputs
        id: target
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          INPUT_REPO: ${{ inputs.target_repo }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "repo=$INPUT_REPO" >> $GITHUB_OUTPUT
          else
            # Extract URL from issue body using regex
            EXTRACTED=$(echo "$ISSUE_BODY" | grep -oP 'github\.com\/\K[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+' | head -n 1)
            
            if [[ -z "$EXTRACTED" ]]; then
              echo "::error::No GitHub repository URL found in the issue description."
              exit 1
            fi
            echo "repo=$EXTRACTED" >> $GITHUB_OUTPUT
          fi

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: false

      - name: Install detection tool
        run: go install github.com/go-enry/go-license-detector/v4/cmd/license-detector@latest

      # --- PHASE 1: READ-ONLY ANALYSIS ---
      # We clone via HTTPS (no token) to check files without polluting our account with a fork yet.
      - name: Analyze Repository (Read-Only)
        id: analyze
        env:
          REPO: ${{ steps.target.outputs.repo }}
        run: |
          echo "::group::Read-only Clone"
          # Clone depth 1 for speed, no auth required for public repos
          git clone --depth 1 "https://github.com/$REPO.git" temp_analysis
          cd temp_analysis
          echo "::endgroup::"

          echo "::group::Detection Logic"
          
          # 1. Manual file check (Fail safe if GH API missed it)
          if ls LICENSE* COPYING* >/dev/null 2>&1; then
             echo "::warning::License file already exists in repository."
             echo "exists=true" >> $GITHUB_OUTPUT
             exit 0
          fi

          LICENSE_TYPE=""

          # 2. Check package.json for explicit license
          if [[ -f "package.json" ]]; then
            LICENSE_TYPE=$(jq -r '.license // empty' package.json)
            echo "Found package.json license: $LICENSE_TYPE"
          fi

          # 3. Heuristic check (scan READMEs) if not found yet
          if [[ -z "$LICENSE_TYPE" ]]; then
            echo "Scanning READMEs with license-detector..."
            # Parse JSON output from license-detector
            LICENSE_TYPE=$(license-detector . --format json | jq -r '.[0].matches[0].license // empty')
            echo "Heuristic detection: $LICENSE_TYPE"
          fi
          
          echo "::endgroup::"

          # 4. Determine Outcome
          if [[ -n "$LICENSE_TYPE" && "$LICENSE_TYPE" != "null" ]]; then
            echo "Resolved missing license: $LICENSE_TYPE"
            echo "type=$LICENSE_TYPE" >> $GITHUB_OUTPUT
            echo "fix_needed=true" >> $GITHUB_OUTPUT
          else
            echo "::notice::Could not detect a missing license type to apply."
            echo "fix_needed=false" >> $GITHUB_OUTPUT
          fi
          
          # Cleanup
          cd ..
          rm -rf temp_analysis

      - name: Report Status (No Fix Needed)
        if: steps.analyze.outputs.fix_needed != 'true' && github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          EXISTS: ${{ steps.analyze.outputs.exists }}
        run: |
          MSG="⚠️ **Aborted:** Could not detect a valid license type to apply automatically."
          if [[ "$EXISTS" == "true" ]]; then
            MSG="⚠️ **Aborted:** A LICENSE file already exists in the repository."
          fi
          gh issue comment "$ISSUE_NUM" --body "$MSG"
          gh issue close "$ISSUE_NUM" --reason "not planned"

      # --- PHASE 2: EXECUTION (Only if fix is needed) ---
      
      - name: Fork and Clone
        if: steps.analyze.outputs.fix_needed == 'true'
        env:
          # Forking requires PAT
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
          REPO: ${{ steps.target.outputs.repo }}
        run: |
          # Fork to the bot/user account and clone authenticated
          gh repo fork "$REPO" --clone --default-branch-only 
          
          # Extract directory name for subsequent steps
          DIR_NAME=$(echo "$REPO" | cut -d'/' -f2)
          echo "REPO_DIR=$DIR_NAME" >> $GITHUB_ENV

      - name: Generate License File
        if: steps.analyze.outputs.fix_needed == 'true'
        working-directory: ${{ env.REPO_DIR }}
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
          TYPE: ${{ steps.analyze.outputs.type }}
          REPO: ${{ steps.target.outputs.repo }}
        run: |
          TEMPLATE=$(gh api licenses/"$TYPE" --jq '.body')
          
          if [[ -z "$TEMPLATE" ]]; then
            echo "::error::GitHub does not have a template for '$TYPE'."
            exit 1
          fi

          YEAR=$(date +%Y)
          
          AUTHOR=""
          if [[ -f "package.json" ]]; then
            AUTHOR=$(jq -r '.author // .author.name // empty' package.json)
          fi
          if [[ -z "$AUTHOR" ]]; then
            AUTHOR=$(echo "$REPO" | cut -d'/' -f1)
          fi

          echo "$TEMPLATE" | sed "s/\[year\]/$YEAR/g" | sed "s/\[fullname\]/$AUTHOR/g" > LICENSE

      - name: Create Pull Request
        if: steps.analyze.outputs.fix_needed == 'true'
        working-directory: ${{ env.REPO_DIR }}
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
          TYPE: ${{ steps.analyze.outputs.type }}
          REPO: ${{ steps.target.outputs.repo }}
        run: |
          git config user.name "Gentle License Bot"
          git config user.email "actions@github.com"
          
          git checkout -b chore/add-license
          git add LICENSE
          git commit -m "chore: add missing $TYPE license"
          git push -u origin chore/add-license

          PR_URL=$(gh pr create \
            --repo "$REPO" \
            --title "chore: add missing LICENSE file" \
            --body "I noticed this repository was missing a LICENSE file. I detected **$TYPE** in your project metadata and have auto-generated the standard text for you." \
            --head chore/add-license)
          
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV

      - name: Notify User Success
        if: steps.analyze.outputs.fix_needed == 'true' && github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
        run: |
          gh issue comment "$ISSUE_NUM" --body "✅ **Success!** I have opened a PR here: ${{ env.PR_URL }}"
