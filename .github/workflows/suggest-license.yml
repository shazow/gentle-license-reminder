name: Auto-Fix Missing License

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Target Repository (e.g. facebook/react)"
        required: true
        type: string
  issues:
    types: [labeled, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  fix-license:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' || 
      (contains(github.event.issue.labels.*.name, 'missing-license') && github.actor == github.repository_owner)

    steps:
      - name: Validate Inputs
        id: target
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          INPUT_REPO: ${{ inputs.target_repo }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "repo=$INPUT_REPO" >> $GITHUB_OUTPUT
          else
            # Extract URL from issue body using regex
            EXTRACTED=$(echo "$ISSUE_BODY" | grep -oP 'github\.com\/\K[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+' | head -n 1)
            
            if [[ -z "$EXTRACTED" ]]; then
              echo "::error::No GitHub repository URL found in the issue description."
              exit 1
            fi
            echo "repo=$EXTRACTED" >> $GITHUB_OUTPUT
          fi

      - name: Check for Existing License
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ steps.target.outputs.repo }}
        run: |
          # Use GH CLI to check if GitHub already detects a license
          LICENSE_INFO=$(gh repo view "$REPO" --json licenseInfo -q '.licenseInfo.key')
          
          if [[ "$LICENSE_INFO" != "other" && "$LICENSE_INFO" != "null" && -n "$LICENSE_INFO" ]]; then
            echo "::notice::Repository $REPO already has a detected license ($LICENSE_INFO)."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Close Issue (If License Exists)
        if: steps.check.outputs.exists == 'true' && github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
        run: |
          gh issue comment "$ISSUE_NUM" --body "⚠️ **Aborted:** The target repository already has a detected license. Issue closed."
          gh issue close "$ISSUE_NUM" --reason "not planned"

      # --- Logic Gate: Stop here if license exists ---
      - name: End Workflow
        if: steps.check.outputs.exists == 'true'
        run: exit 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: false # Caching not needed for a quick tool install

      - name: Install detection tool
        run: go install github.com/go-enry/go-license-detector/v4/cmd/license-detector@latest

      - name: Fork and Clone
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ steps.target.outputs.repo }}
        run: |
          # Fork to the bot/user account and clone
          gh repo fork "$REPO" --clone --default-branch-only 
          
          # Extract directory name and set for future steps
          DIR_NAME=$(echo "$REPO" | cut -d'/' -f2)
          echo "REPO_DIR=$DIR_NAME" >> $GITHUB_ENV

      # --- All subsequent steps run inside the repo directory ---
      - name: Detect License Type
        id: detect
        working-directory: ${{ env.REPO_DIR }}
        run: |
          echo "Running detection..."
          LICENSE_TYPE=""

          # 1. Check package.json
          if [[ -f "package.json" ]]; then
            LICENSE_TYPE=$(jq -r '.license // empty' package.json)
          fi

          # 2. Heuristic check if package.json failed
          if [[ -z "$LICENSE_TYPE" ]]; then
            echo "Scanning READMEs..."
            # Parse JSON output from license-detector
            LICENSE_TYPE=$(license-detector . --format json | jq -r '.[0].matches[0].license // empty')
          fi

          if [[ -z "$LICENSE_TYPE" ]]; then
            echo "::error::Could not detect a license type from metadata."
            exit 1
          fi

          echo "Detected: $LICENSE_TYPE"
          echo "type=$LICENSE_TYPE" >> $GITHUB_OUTPUT

      - name: Generate License File
        working-directory: ${{ env.REPO_DIR }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TYPE: ${{ steps.detect.outputs.type }}
          REPO: ${{ steps.target.outputs.repo }}
        run: |
          # Fetch standard text from GitHub API
          TEMPLATE=$(gh api licenses/"$TYPE" --jq '.body')
          
          if [[ -z "$TEMPLATE" ]]; then
            echo "::error::GitHub does not have a template for '$TYPE'."
            exit 1
          fi

          YEAR=$(date +%Y)
          
          # Attempt to find Author Name
          AUTHOR=""
          if [[ -f "package.json" ]]; then
            AUTHOR=$(jq -r '.author // .author.name // empty' package.json)
          fi
          # Fallback to Repo Owner
          if [[ -z "$AUTHOR" ]]; then
            AUTHOR=$(echo "$REPO" | cut -d'/' -f1)
          fi

          # Replace placeholders
          echo "$TEMPLATE" | sed "s/\[year\]/$YEAR/g" | sed "s/\[fullname\]/$AUTHOR/g" > LICENSE

      - name: Create Pull Request
        working-directory: ${{ env.REPO_DIR }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TYPE: ${{ steps.detect.outputs.type }}
          REPO: ${{ steps.target.outputs.repo }}
        run: |
          git config user.name "Gentle License Bot"
          git config user.email "actions@github.com"
          
          git checkout -b chore/add-license
          git add LICENSE
          git commit -m "chore: add missing $TYPE license"
          git push -u origin chore/add-license

          PR_URL=$(gh pr create \
            --repo "$REPO" \
            --title "chore: add missing LICENSE file" \
            --body "I noticed this repository was missing a LICENSE file. I detected **$TYPE** in your project metadata and have auto-generated the standard text for you." \
            --head chore/add-license)
          
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV

      - name: Notify User
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
        run: |
          gh issue comment "$ISSUE_NUM" --body "✅ **Success!** I have opened a PR here: ${{ env.PR_URL }}"
